name: sbom-analyzer
version: 1.0.0
description: |
  Analyzes Software Bill of Materials (SBOM) files to extract package information,
  verify repository status, and check for unmaintained dependencies.
  
  Supports multiple package ecosystems including npm, Go, .NET, PyPI, and more.
  
author: Kitty Team
license: MIT

variables:
  sbom_file: ""
  output_format: "markdown"

tasks:
  - name: count_github_packages
    description: Count total GitHub packages in SBOM
    tool: execute_command
    input:
      command: grep -o 'pkg:golang/github.com/[^"]*' "${sbom_file}" | wc -l
    output: package_count

  - name: get_package_1
    description: Extract first GitHub package PURL
    tool: execute_command
    input:
      command: grep -o 'pkg:golang/github.com/[^"]*' "${sbom_file}" | sed -n '1p'
    output: purl_1

  - name: parse_package_1
    description: Parse first package PURL
    condition: purl_1 exists
    prompt: |
      Parse this single PURL: ${purl_1}

      Example: pkg:golang/github.com/gin-gonic/gin@v1.11.0
      Extract: owner=gin-gonic, repo=gin, version=v1.11.0

      Return JSON (no markdown):
      {"owner": "username", "repo": "reponame", "purl": "${purl_1}", "version": "version"}
    output: package_1_info

  - name: check_package_1
    description: Check maintenance of package 1
    condition: package_1_info exists
    tool: github_check_maintenance
    input:
      owner: "${package_1_info.owner}"
      repo: "${package_1_info.repo}"
    output: package_1_status

  - name: get_package_2
    description: Extract second GitHub package PURL
    tool: execute_command
    input:
      command: grep -o 'pkg:golang/github.com/[^"]*' "${sbom_file}" | sed -n '2p'
    output: purl_2

  - name: parse_package_2
    description: Parse second package PURL
    condition: purl_2 exists
    prompt: |
      Parse this single PURL: ${purl_2}
      Return JSON (no markdown):
      {"owner": "username", "repo": "reponame", "purl": "${purl_2}", "version": "version"}
    output: package_2_info

  - name: check_package_2
    description: Check maintenance of package 2
    condition: package_2_info exists
    tool: github_check_maintenance
    input:
      owner: "${package_2_info.owner}"
      repo: "${package_2_info.repo}"
    output: package_2_status

  - name: get_package_3
    description: Extract third GitHub package PURL
    tool: execute_command
    input:
      command: grep -o 'pkg:golang/github.com/[^"]*' "${sbom_file}" | sed -n '3p'
    output: purl_3

  - name: parse_package_3
    description: Parse third package PURL
    condition: purl_3 exists
    prompt: |
      Parse this single PURL: ${purl_3}
      Return JSON (no markdown):
      {"owner": "username", "repo": "reponame", "purl": "${purl_3}", "version": "version"}
    output: package_3_info

  - name: check_package_3
    description: Check maintenance of package 3
    condition: package_3_info exists
    tool: github_check_maintenance
    input:
      owner: "${package_3_info.owner}"
      repo: "${package_3_info.repo}"
    output: package_3_status

  - name: get_package_4
    description: Extract fourth GitHub package PURL
    tool: execute_command
    input:
      command: grep -o 'pkg:golang/github.com/[^"]*' "${sbom_file}" | sed -n '4p'
    output: purl_4

  - name: parse_package_4
    description: Parse fourth package PURL
    condition: purl_4 exists
    prompt: |
      Parse this single PURL: ${purl_4}
      Return JSON (no markdown):
      {"owner": "username", "repo": "reponame", "purl": "${purl_4}", "version": "version"}
    output: package_4_info

  - name: check_package_4
    description: Check maintenance of package 4
    condition: package_4_info exists
    tool: github_check_maintenance
    input:
      owner: "${package_4_info.owner}"
      repo: "${package_4_info.repo}"
    output: package_4_status

  - name: get_package_5
    description: Extract fifth GitHub package PURL
    tool: execute_command
    input:
      command: grep -o 'pkg:golang/github.com/[^"]*' "${sbom_file}" | sed -n '5p'
    output: purl_5

  - name: parse_package_5
    description: Parse fifth package PURL
    condition: purl_5 exists
    prompt: |
      Parse this single PURL: ${purl_5}
      Return JSON (no markdown):
      {"owner": "username", "repo": "reponame", "purl": "${purl_5}", "version": "version"}
    output: package_5_info

  - name: check_package_5
    description: Check maintenance of package 5
    condition: package_5_info exists
    tool: github_check_maintenance
    input:
      owner: "${package_5_info.owner}"
      repo: "${package_5_info.repo}"
    output: package_5_status

  - name: generate_report
    description: Generate comprehensive SBOM security report
    prompt: |
      Generate a comprehensive SBOM security report:

      Total GitHub Packages Found: ${package_count}

      Package 1: ${package_1_info}
      Status: ${package_1_status}

      Package 2: ${package_2_info}
      Status: ${package_2_status}

      Package 3: ${package_3_info}
      Status: ${package_3_status}

      Package 4: ${package_4_info}
      Status: ${package_4_status}

      Package 5: ${package_5_info}
      Status: ${package_5_status}

      Format as ${output_format}:
      ## SBOM Security Analysis Report

      **Total Packages:** ${package_count} GitHub packages detected

      ### Analyzed Packages

      For each package above, create a section with:
      - **Package Name** and GitHub URL
      - **Version** from PURL
      - **Latest Commit:** SHA and date
      - **Maintenance Status:** (maintained/stale/unmaintained/archived)
      - **Stars/Forks/Issues**
      - **Recommendation**

      ### Security Summary
      - List any unmaintained or archived packages
      - Overall risk assessment

      Keep it concise and actionable.
    output: final_report
